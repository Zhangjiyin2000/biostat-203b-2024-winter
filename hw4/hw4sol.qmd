---
title: "Biostat 203B Homework 4"
subtitle: "Due Mar 8 @ 11:59PM"
author: "Jiyin (Jenny) Zhang, UID:606331859"
format:
  html:
    theme: cosmo
    embed-resources: true
    number-sections: false
    toc: true
    toc-depth: 4
    toc-location: left
    code-fold: false
execute:
  eval: true
---

Display machine information:
```{r}
sessionInfo()
```
Display my machine memory.
```{r}
memuse::Sys.meminfo()
```

Load database libraries and the tidyverse frontend:
```{r}
# install.packages("forcats")
library(forcats)
library(bigrquery)
library(dbplyr)
library(DBI)
library(gt)
library(gtsummary)
library(tidyverse)
```

## Q1. Compile the ICU cohort in HW3 from the Google BigQuery database 

Below is an outline of steps. In this homework, we exclusively work with the BigQuery database and should not use any MIMIC data files stored on our local computer. Transform data as much as possible in BigQuery database and `collect()` the tibble only at the end of Q1.7.

### Q1.1 Connect to BigQuery

Authenticate with BigQuery using the service account token. Please place the service account token (shared via BruinLearn) in the working directory (same folder as your qmd file). Do **not** add this token to your git repository.
```{r}
# path to the service account token
satoken <- "biostat-203b-2024-winter-313290ce47a6.json"
# BigQuery authentication using service account
bq_auth(path = satoken)
```
Connect to BigQuery database `mimic4_v2_2` in GCP (Google Cloud Platform), using the project billing account `biostat-203b-2024-winter`.
```{r}
# connect to the BigQuery database `biostat-203b-2024-winter.mimic4_v2_2`
con_bq <- dbConnect(
  bigrquery::bigquery(),
  project = "biostat-203b-2024-winter",
  dataset = "mimic4_v2_2",
  billing = "biostat-203b-2024-winter"
)
con_bq
```
List all tables in the `mimic4_v2_2` database.
```{r}
dbListTables(con_bq)
```
### Q1.2 `icustays` data

Connect to the `icustays` table.

**Answer:**

```{r}
# full ICU stays table
icustays_tble <- tbl(con_bq, "icustays") |>
  arrange(subject_id, stay_id) |>
  # show_query() |>
  print(width = Inf)
```

### Q1.3 `admissions` data

Connect to the `admissions` table.

**Answer:**

```{r}
# full admissions table
admissions_tble <- tbl(con_bq, "admissions") |>
  arrange(subject_id, hadm_id) |>
  # show_query() |>
  print(width = Inf)
```

### Q1.4 `patients` data

Connect to the `patients` table.

**Answer:**

```{r}
# full patients table
patients_tble <- tbl(con_bq, "patients") |>
  arrange(subject_id) |>
  # show_query() |>
  print(width = Inf)
```

### Q1.5 `labevents` data

Connect to the `labevents` table and retrieve a subset that only contain subjects who appear in `icustays_tble` and the lab items listed in HW3. Only keep the last lab measurements before the ICU stay and pivot lab items to become variables/columns. Write all steps in _one_ chain of pipes.

**Answer:**

```{r}
labevents_tble <- tbl(con_bq, "labevents") |>
  right_join(
    icustays_tble,
    by = "subject_id"
  ) |>
  filter(itemid %in%
    c(50912, 50971, 50983, 50902, 50882, 51221, 51301, 50931)) |>
  filter(storetime < intime) |>
  group_by(subject_id, stay_id, itemid) %>%
  slice_max(n = 1, order_by = storetime) %>%
  ungroup() |>
  left_join(
    tbl(con_bq, "d_labitems"),
    by = "itemid"
  ) |>
  pivot_wider(
    id_cols = c(subject_id, stay_id),
    names_from = label,
    values_from = valuenum
  ) |>
  arrange(subject_id, stay_id) |>
  rename(
    "wbc" = "White Blood Cells",
    "bicarbonate" = "Bicarbonate",
    "chloride" = "Chloride",
    "creatinine" = "Creatinine",
    "glucose" = "Glucose",
    "potassium" = "Potassium",
    "sodium" = "Sodium",
    "hematocrit" = "Hematocrit"
  ) |>
  select(
    subject_id, stay_id, "bicarbonate", "chloride", "creatinine",
    "glucose", "potassium", "sodium", "hematocrit", "wbc"
  ) |>
  print(width = Inf)
```

### Q1.6 `chartevents` data

Connect to `chartevents` table and retrieve a subset that only contain subjects who appear in `icustays_tble` and the chart events listed in HW3. Only keep the first chart events during ICU stay and pivot chart events to become variables/columns. Write all steps in _one_ chain of pipes.

**Answer:**

```{r}
chartevents_tble <- tbl(con_bq, "chartevents") |>
  right_join(
    icustays_tble,
    by = "subject_id"
  ) |>
  filter(itemid %in%
    c(220045, 220179, 220180, 223761, 220210)) %>%
  filter(charttime >= intime & charttime <= outtime) |>
  group_by(subject_id, stay_id_x, itemid) %>%
  slice_min(n = 1, order_by = charttime) %>%
  ungroup() |>
  left_join(
    tbl(con_bq, "d_items"),
    by = "itemid"
  ) |>
  pivot_wider(
    id_cols = c(subject_id, stay_id_x),
    names_from = label,
    values_from = valuenum
  ) |>
  rename(stay_id = stay_id_x) |>
  arrange(subject_id, stay_id) |>
  rename(
    "heart_rate" = "Heart Rate",
    "non_invasive_blood_pressure_systolic" = "Non Invasive Blood Pressure systolic",
    "non_invasive_blood_pressure_diastolic" = "Non Invasive Blood Pressure diastolic",
    "temperature_fahrenheit" = "Temperature Fahrenheit",
    "respiratory_rate" = "Respiratory Rate"
  ) |>
  # change the order of the columns
  select(subject_id, stay_id, "heart_rate", "non_invasive_blood_pressure_systolic", "non_invasive_blood_pressure_diastolic", "respiratory_rate", "temperature_fahrenheit") |>
  print(width = Inf)
```

### Q1.7 Put things together

This step is similar to Q7 of HW3. Using _one_ chain of pipes `|>` to perform following data wrangling steps: (i) start with the `icustays_tble`, (ii) merge in admissions and patients tables, (iii) keep adults only (age at ICU intime >= 18), (iv) merge in the labevents and chartevents tables, (v) `collect` the tibble.

```{r}
mimic_icu_cohort <- icustays_tble |>
  inner_join(admissions_tble, by = c("subject_id", "hadm_id")) |>
  inner_join(patients_tble, by = "subject_id") |>
  mutate(age_intime = year(intime) - anchor_year + anchor_age) |>
  filter(age_intime >= 18) |>
  left_join(labevents_tble, by = c("stay_id")) |>
  left_join(chartevents_tble, by = c("stay_id")) |>
  select(-c(subject_id_x, subject_id_y)) |>
  select(
    subject_id, hadm_id, stay_id, first_careunit, last_careunit, intime,
    outtime, los, admittime, dischtime, deathtime, admission_type,
    admit_provider_id, admission_location, discharge_location, insurance,
    language, marital_status, race, edregtime, edouttime,
    hospital_expire_flag, gender, anchor_age, anchor_year,
    anchor_year_group, dod, bicarbonate, chloride, creatinine, glucose,
    potassium, sodium, hematocrit, wbc, heart_rate,
    non_invasive_blood_pressure_systolic,
    non_invasive_blood_pressure_diastolic, respiratory_rate,
    temperature_fahrenheit, age_intime
  ) |>
  collect() |>
  print(width = Inf)
```

### Q1.8 Preprocessing

Perform the following preprocessing steps. (i) Lump infrequent levels into "Other" level for `first_careunit`, `last_careunit`, `admission_type`, `admission_location`, and `discharge_location`. (ii) Collapse the levels of `race` into `ASIAN`, `BLACK`, `HISPANIC`, `WHITE`, and `Other`. (iii) Create a new variable `los_long` that is `TRUE` when `los` is greater than or equal to 2 days. (iv) Summarize the data using `tbl_summary()`, stratified by `los_long`. Hint: `fct_lump` and `fct_collapse` from the `forcats` package can be useful.

Hint: Below is a numerical summary of my tibble after preprocessing:

<iframe width=95% height="500" src="./mimic_icu_cohort_gtsummary.html"></iframe>

**Answer:**

```{r}
mimic_icu_cohort_tbl <- mimic_icu_cohort |>
  mutate(
    first_careunit = fct_lump(first_careunit, n = 4),
    last_careunit = fct_lump(last_careunit, n = 4),
    admission_type = fct_lump(admission_type, n = 4),
    admission_location = fct_lump(admission_location, n = 3),
    discharge_location = fct_lump(discharge_location, n = 4)
  ) |>
  mutate(race = case_when(
    grepl("ASIAN", race, ignore.case = TRUE) ~ "ASIAN",
    grepl("BLACK|AFRICAN AMERICAN", race, ignore.case = TRUE) ~ "BLACK",
    grepl("HISPANIC|LATINO", race, ignore.case = TRUE) ~ "HISPANIC",
    grepl("WHITE", race, ignore.case = TRUE) ~ "WHITE",
    TRUE ~ "OTHER"
  )) |>
  mutate(
    los_long = (los >= 2)
  ) |>
  print(width = Inf)
```

```{r}
mimic_icu_cohort_tbl |>
  select(
    first_careunit, last_careunit, los, admission_type, admission_location,
    discharge_location, insurance, language, marital_status, race,
    hospital_expire_flag, gender, dod, sodium, chloride, creatinine, potassium,
    glucose, hematocrit, wbc, bicarbonate, temperature_fahrenheit,
    non_invasive_blood_pressure_diastolic, respiratory_rate,
    non_invasive_blood_pressure_systolic, heart_rate, age_intime, los_long
  ) |>
  tbl_summary(by = los_long) |>
  print()
```

### Q1.9 Save the final tibble

Save the final tibble to an R data file `mimic_icu_cohort.rds` in the `mimiciv_shiny` folder.

```{r}
# make a directory mimiciv_shiny
if (!dir.exists("mimiciv_shiny")) {
  dir.create("mimiciv_shiny")
}
# save the final tibble
mimic_icu_cohort_tbl |>
  write_rds("mimiciv_shiny/mimic_icu_cohort.rds", compress = "gz")
```

Close database connection and clear workspace.

```{r}
if (exists("con_bq")) {
  dbDisconnect(con_bq)
}
rm(list = ls())
```

Although it is not a good practice to add big data files to git, for grading purpose, please add `mimic_icu_cohort.rds` to your git repository.

## Q2. Shiny app

Develop a Shiny app for exploring the ICU cohort data created in Q1. The app should reside in the `mimiciv_shiny` folder. The app should contains at least two tabs. One tab provides easy access to the graphical and numerical summaries of variables (demographics, lab measurements, vitals) in the ICU cohort. The other allows user to choose a specific patient in the cohort and display the patient's ADT and ICU stay information as we did in Q1 of HW3.

**Answer:**



```{r}
library(ggplot2)
# install.packages("devtools")
library(devtools)
# Install dqshiny from GitHub
devtools::install_github("daqana/dqshiny")
library(shiny)

# read the dataset
dataset <- readRDS("mimic_icu_cohort.rds")
longData <- dataset %>%
  pivot_longer(
    cols = c(
      "bicarbonate", "chloride", "creatinine",
      "glucose", "potassium", "sodium",
      "hematocrit", "wbc"
    ),
    names_to = "vital_lab",
    values_to = "Value_lab"
  ) 
longData_chart <- dataset %>%
  pivot_longer(
    cols = c(
      "heart_rate", "non_invasive_blood_pressure_systolic", 
      "non_invasive_blood_pressure_diastolic", "temperature_fahrenheit", 
      "respiratory_rate"
    ),
    names_to = "vital_chart",
    values_to = "Value_chart"
  )

ui <- fluidPage(
  
  # App title ----
  titlePanel("MIMIC-IV Cohort Explorer"),
  fluidRow(
    tabsetPanel(
      tabPanel("Categorical Data Summary",
               tableOutput("summaryTable")
      ),
      tabPanel(
        "Continuous Data Summary",
        # Sidebar layout with input and output definitions ----
        sidebarLayout(
          
          # Sidebar panel for inputs ----
          sidebarPanel(
            
            # Input: Selector for choosing dataset ----
            selectInput(
              inputId = "variable",
              label = "Variable of interest",
              choices = c(
                "Chart Events Vitals" = "vital_chart",
                "Lab Events Vitals" = "vital_lab",
                "Age" = "age_intime"
              )
            )
          
          ),
          mainPanel(
            tableOutput("summary_continuous")
          )
        )
      ),
      tabPanel(
        "Patient characteristics",
        verbatimTextOutput("summary"),
        # Sidebar layout with input and output definitions ----
        sidebarLayout(
          
          # Sidebar panel for inputs ----
          sidebarPanel(
            
            # Input: Selector for choosing dataset ----
            selectInput(
              inputId = "var",
              label = "Variable of interest",
              choices = c(
                "Last Care Unit" = "last_careunit",
                "Lab Events" = "lab_events",
                "Gender" = "gender",
                "Race" = "race",
                "Marital Status" = "marital_status",
                "Insurance" = "insurance",
                "Discharge Location" = "discharge_location",
                "Admission Type" = "admission_type",
                "Admission Location" = "admission_location",
                "First Care Unit" = "first_careunit",
                "Age" = "age_intime"
              )
            ),
            checkboxInput(
              "outliers",
              "Remove outliers in IQR method for measurements?",
              FALSE
            )
          ),
          mainPanel(
            plotOutput("plot1")
          )
        )
      ),
      tabPanel(
        "Patient's ADT and ICU stay infomation",
        tableOutput("view"),
        # Sidebar layout with input and output definitions ----
        sidebarLayout(
          
          # Sidebar panel for inputs ----
          sidebarPanel(
            
            # Input:  ----
            # make a number input box into the UI.
            tags$p("Select a patient."),
            selectInput("subject_id", 
                           label = "Patient ID", 
                           choices = sample(unique(dataset$subject_id), 5)
            )
          ),
          mainPanel(
            plotOutput("plot2")
          )
        )
      )
    )
  )
)

server <- function(input, output, session) {
  
  # read the dataset
  dataset <- readRDS("mimic_icu_cohort.rds")
  
  # Plot for the first tab ----------------------Patient characteristics
  output$plot1 <- renderPlot({
    if (input$var == "last_careunit") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Last Care Unit"
        )
    } else if (input$var == "lab_events") {
      # Melt (pivot) the dataset for only the lab events columns
      longData <- dataset %>%
        pivot_longer(
          cols = c(
            "bicarbonate", "chloride", "creatinine",
            "glucose", "potassium", "sodium",
            "hematocrit", "wbc"
          ),
          names_to = "LabEvent",
          values_to = "Value"
        )
      
      # Remove outliers if the checkbox is checked
      if (input$outliers) {
        filterlongData <- longData %>%
          group_by(LabEvent) %>%
          # Calculate the IQR and filter within the same pipeline
          mutate(
            Q1 = quantile(Value, 0.25, na.rm = TRUE),
            Q3 = quantile(Value, 0.75, na.rm = TRUE),
            IQR = Q3 - Q1,
            LowerBound = Q1 - 1.5 * IQR,
            UpperBound = Q3 + 1.5 * IQR
          ) %>%
          filter(Value >= LowerBound & Value <= UpperBound) %>%
          select(-c(Q1, Q3, IQR, LowerBound, UpperBound)) # Remove the helper columns
        
        # Plot boxplots for all lab events
        ggplot(filterlongData, aes(x = LabEvent, y = Value)) +
          geom_boxplot() +
          theme_minimal() +
          labs(title = "Distribution of Lab Events across Patients", 
               x = "Lab Event", 
               y = "Value") +
          # Rotate x-axis labels for readability
          theme(axis.text.x = element_text(angle = 45, hjust = 1))  +
          coord_flip()
      } else {
        # Plot boxplots for all lab events
        ggplot(longData, aes(x = LabEvent, y = Value)) +
          geom_boxplot() +
          theme_minimal() +
          labs(title = "Distribution of Lab Events across Patients", 
               x = "Lab Event", 
               y = "Value") +
          # Rotate x-axis labels for readability
          theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
          coord_flip()
      }
    } else if (input$var == "gender") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Gender")
    } else if (input$var == "race") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Race")
    } else if(input$var == "marital_status") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Marital Status")
    } else if(input$var == "insurance") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Insurance")
    } else if(input$var == "discharge_location") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Discharge Location")
    } else if(input$var == "admission_type") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Admission Type")
    } else if(input$var == "admission_location") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Admission Location")
    } else if(input$var == "first_careunit") {
      ggplot(dataset, aes_string(input$var)) +
        geom_bar(position = position_stack(reverse = TRUE)) +
        coord_flip() +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "First Care Unit")
    } else if(input$var == "age_intime") {
      ggplot(dataset, aes_string(input$var)) +
        geom_histogram(binwidth = 5) +
        theme_minimal() +
        labs(
          title = "Patient count by stay or patient variable group",
          y = "Count",
          x = "Age")
    }
    
  })
  
  
  # Plot for the second tab --- Patient's ADT and ICU stay infomation
  output$plot2 <- renderPlot({

      # produce the sub-dataset we need to plot
      
      sid_adt <- tbl(con_bq, "transfers") %>%
        filter(subject_id == input$subject_id) %>%
        filter(eventtype != "discharge") |>
        mutate(
          linewidth = ifelse(
            str_detect(careunit, "(ICU|CCU)"), 3, 1
          )
        ) 
      
      sid_proce <- tbl(con_bq, "procedures_icd") %>%
        filter(subject_id == as.numeric(input$subject_id)) 
      
      sid_lab <- labevents_tble %>%
        filter(subject_id == as.numeric(input$subject_id)) %>%
        collect()
      
      sid_patients <- patients_tble %>%
        filter(subject_id == as.numeric(input$subject_id))
      
      sid_proce2 <- tbl(con_bq, "d_icd_procedures") %>%
        filter(subject_id == as.numeric(input$subject_id)) 
      
      sid_dia <- tbl(con_bq, "diagnoses_icd") %>% 
        filter(subject_id == as.numeric(input$subject_id))
      
      sid_dia2 <- tbl(con_bq, "d_icd_diagnoses") %>%
        filter(subject_id == as.numeric(input$subject_id))
      
      # merge the dataset to plot
      sid_dia_all <- left_join(sid_dia, sid_dia2, by = "icd_code", "icd_version")
      count(sid_dia_all, long_title, sort = T)
      sid_proce_all <- left_join(sid_proce, sid_proce2, 
                                 by = "icd_code", "icd_version")
      sid_proce_all$chartdate <- as.POSIXct(sid_proce$chartdate)
      
    # Plot the patient's information ------------------------------
    ggplot() +
      geom_point(
        data = sid_proce_all,
        aes(x = chartdate, y = "Procedure", shape = long_title)
      ) +
      geom_point(
        data = sid_lab,
        aes(x = charttime, y = "Lab"), shape = 3
      ) +
      geom_segment(
        data = sid_adt,
        aes(x = intime, xend = outtime, y = "ADT", yend = "ADT", color = careunit),
        linewidth = sid_adt$linewidth
      ) +
      scale_y_discrete(limits = c("Procedure", "Lab", "ADT")) +
      labs(
        x = "Calendar Time",
        y = "",
        color = "Care Unit",
        shape = "Procedure",
        title = paste(
          "Patient ", input$patient_id, "F, ",
          "70 ", "years old, ", "Black/African"
        ),
        subtitle = "Acute on chronic systolic (congestive) heart failure \nHyperlipidemia, unspecified \nLong term (current) use of insulin \nOther chronic pain"
      ) +
      theme(
        legend.position = "bottom",
        legend.box = "vertical",
        legend.title = element_text(size = 9)
      ) +
      guides(
        shape = guide_legend(nrow = 9, byrow = TRUE)
      ) +
      scale_shape_manual(values = 1:9)
  })
  
 
  
  # Categorical Data --- Summary table -----------------------------------------
  output$summaryTable <- renderTable({
    cat_data <- dataset %>%
      select(
        first_careunit, last_careunit, los, admission_type, admission_location,
        discharge_location, insurance, language, marital_status, race,
        hospital_expire_flag, gender, dod
      ) |>
      tbl_summary()
    
   
  })
  
  # Continuous Data --- Summary table (using dropdown) -----------------------
  output$summary_continuous<- renderTable({
    if(input$variable == "vital_chart") {
      longData_chart  %>%
        
        group_by(vital_chart) %>%
        summarise(
          Mean = mean(Value_chart, na.rm = TRUE),
          Median = median(Value_chart, na.rm = TRUE),
          min = min(Value_chart, na.rm = TRUE),
          max = max(Value_chart, na.rm = TRUE),
          `Standard Deviation` = sd(Value_chart, na.rm = TRUE),
          Q1 = quantile(Value_chart, 0.25, na.rm = TRUE),
          Q3 = quantile(Value_chart, 0.75, na.rm = TRUE)
        ) %>%
        ungroup()
    } else if(input$variable == "vital_lab") {
      
        longData %>%
          group_by(vital_lab) %>%
          summarise(
            Mean = mean(Value_lab, na.rm = TRUE),
            Median = median(Value_lab, na.rm = TRUE),
            min = min(Value_lab, na.rm = TRUE),
            max = max(Value_lab, na.rm = TRUE),
            `Standard Deviation` = sd(Value_lab, na.rm = TRUE),
            Q1 = quantile(Value_lab, 0.25, na.rm = TRUE),
            Q3 = quantile(Value_lab, 0.75, na.rm = TRUE)
          ) %>%
          ungroup()
    } else if(input$variable == "age_intime") {
      cat_data <- dataset %>%
        select(age_intime) |>
        summarise(
          Mean = mean(age_intime, na.rm = TRUE),
          Median = median(age_intime, na.rm = TRUE),
          min = min(age_intime, na.rm = TRUE),
          max = max(age_intime, na.rm = TRUE),
          `Standard Deviation` = sd(age_intime, na.rm = TRUE),
          Q1 = quantile(age_intime, 0.25, na.rm = TRUE),
          Q3 = quantile(age_intime, 0.75, na.rm = TRUE)
        ) 
    }
    
    
  })
}

shinyApp(ui, server)
```




